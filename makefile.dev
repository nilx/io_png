# Copyright 2010 IPOL Image Processing On Line http://www.ipol.im/
# Author: Nicolas Limare <nicolas.limare@cmla.ens-cachan.fr>
#
# Copying and distribution of this file, with or without
# modification, are permitted in any medium without royalty provided
# the copyright notice and this notice are preserved.  This file is
# offered as-is, without any warranty.

PROJECT	  = io_png
DATE   	  = $(shell date -u +%Y%m%d)
RELEASE_TAG   = 0.$(DATE)

# use a cached compiler
CC	  = ccache cc

# optimized compilation
COPT += -march=pentium-m -msse3 -ffast-math

ifdef VECTOR
# automatic vectorization
CFLAGS	+= -ftree-vectorize
endif

ifdef VERBOSE
# verbose compilation
CFLAGS	+= -ftree-vectorizer-verbose=2
endif

ifdef DEBUG
# debugging, with electricfence
CFLAGS	= -O0 -g -lefence
endif

# source documentation
srcdoc	: $(SRC)
	doxygen doxygen.conf

# check the source code
.PHONY	: lint
lint	: lint.flag
lint.flag	: $(CSRC)
	splint -weak $?
	touch $@

# update the C headers
io_png.h	: io_png.c
	@echo "" > $@.tmp
	@echo "#ifndef _IO_PNG_H\n#define _IO_PNG_H\n" >> $@.tmp
	@echo "#include <stddef.h>\n" >> $@.tmp
	@echo "#define IO_PNG_VERSION \"$(RELEASE_TAG)\"\n" >> $@.tmp
	@echo "#ifdef __cplusplus\nextern \"C\" {\n#endif\n" >> $@.tmp
	-cproto $< >> $@.tmp
	@echo "" >> $@.tmp
	@echo "#ifdef __cplusplus\n}\n#endif\n" >> $@.tmp
	@echo "#endif /* !_IO_PNG_H */" >> $@.tmp
	mv $@.tmp $@

# cleanup the source code
.PHONY	: beautify
beautify	: beautify.flag
beautify.flag	: $(CSRC)
	for FILE in $?; do \
		expand $$FILE | sed 's/[ \t]*$$//' > $$FILE.$$$$ \
		&& indent -kr -bl -bli0 -i4 -l78 -nut -nce -sob -sc \
			$$FILE.$$$$ -o $$FILE \
		&& rm $$FILE.$$$$; \
	done
	touch $@

.PHONY	: release
release	:
	git archive --format=tar --prefix=$(PROJECT)-$(RELEASE_TAG)/ HEAD \
	        | gzip > ../$(PROJECT)-$(RELEASE_TAG).tgz
